name: Build Linux Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.12)'
        required: true
        default: '6.12'
        type: string

env:
  KERNEL_VERSION: ${{ inputs.kernel_version }}

jobs:
  build-kernel:
    name: Build Kernel (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: [self-hosted, Linux, X64]
            cross_compile: ""
            image_name: vmlinux-x86_64
            kernel_target: vmlinux

          - arch: aarch64
            runner: [self-hosted, Linux, ARM64]
            cross_compile: ""
            image_name: Image-aarch64
            kernel_target: Image

    steps:
      - name: Checkout hypr repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          # Check if required tools are already installed (self-hosted runners)
          MISSING=""
          for tool in gcc make bc bison flex cpio rsync; do
            if ! command -v $tool &> /dev/null; then
              MISSING="$MISSING $tool"
            fi
          done

          # Check for required dev libraries
          if [ ! -f /usr/include/libelf.h ] && [ ! -f /usr/include/elfutils/libelf.h ]; then
            MISSING="$MISSING libelf-dev"
          fi

          if [ -z "$MISSING" ]; then
            echo "All required build tools are already installed"
            gcc --version | head -1
            make --version | head -1
            exit 0
          fi

          echo "Missing tools:$MISSING - attempting to install..."

          # Fix potential apt issues on self-hosted runners
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -f /var/lib/dpkg/lock*

          # Try to fix broken packages first
          sudo dpkg --configure -a || true
          sudo apt-get -f install -y || true

          # Update package lists
          for i in 1 2 3; do
            sudo apt-get update && break
            echo "apt-get update failed (attempt $i), retrying..."
            sudo rm -rf /var/lib/apt/lists/*
            sleep 5
          done

          # Install only missing packages individually to avoid dependency conflicts
          for pkg in gcc g++ make bc bison flex libelf-dev libssl-dev libncurses-dev cpio rsync; do
            if ! dpkg -s $pkg &> /dev/null; then
              echo "Installing $pkg..."
              sudo apt-get install -y $pkg || echo "Warning: Failed to install $pkg"
            fi
          done

          # Verify critical tools
          for tool in gcc make bc; do
            if ! command -v $tool &> /dev/null; then
              echo "ERROR: Required tool '$tool' is not available"
              exit 1
            fi
          done

          echo "Build dependencies ready"
          gcc --version | head -1

      - name: Download mainline kernel
        run: |
          # Download mainline kernel tarball (faster than git clone)
          MAJOR_VERSION=$(echo "${{ inputs.kernel_version }}" | cut -d. -f1)
          KERNEL_URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/linux-${{ inputs.kernel_version }}.tar.xz"

          echo "Downloading kernel from: ${KERNEL_URL}"
          curl -fsSL "${KERNEL_URL}" -o linux.tar.xz

          echo "Extracting kernel..."
          tar -xf linux.tar.xz
          mv linux-${{ inputs.kernel_version }} kernel
          rm linux.tar.xz

          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Configure kernel with minimal virtio config
        working-directory: kernel
        run: |
          # Both architectures use defconfig as base
          # Direct-kernel boot on ARM64 has no size limit (no UEFI involved)
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            make x86_64_defconfig

            # Enable KVM guest support and PVH boot (required for cloud-hypervisor)
            ./scripts/config --enable CONFIG_HYPERVISOR_GUEST
            ./scripts/config --enable CONFIG_KVM_GUEST
            ./scripts/config --enable CONFIG_PARAVIRT
            ./scripts/config --enable CONFIG_PVH
          else
            # ARM64: Use defconfig (direct-kernel boot has no size limit)
            make defconfig

            # === DIRECT KERNEL BOOT (no UEFI) ===
            # Disable EFI so cloud-hypervisor uses direct-kernel boot
            ./scripts/config --disable CONFIG_EFI
            ./scripts/config --disable CONFIG_EFI_STUB
          fi

          # === SIZE REDUCTION: Disable debug info ===
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF4
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF5
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
          ./scripts/config --enable CONFIG_DEBUG_INFO_NONE

          # === SIZE REDUCTION: Disable modules ===
          ./scripts/config --disable CONFIG_MODULES

          # Display initial config info
          echo "Initial config:"
          grep -E "CONFIG_SQUASHFS|CONFIG_OVERLAY_FS|CONFIG_FUSE_FS|CONFIG_VIRTIO|CONFIG_BLOCK" .config | head -20 || true

      - name: Enable additional kernel options for HYPR
        working-directory: kernel
        run: |
          # Append HYPR-specific config options to .config
          # Using cat >> ensures options are added even if not in defconfig
          cat >> .config << 'HYPR_CONFIG'

          # ============================================
          # HYPR Custom Kernel Configuration
          # ============================================

          # PVH boot support (required for cloud-hypervisor x86_64)
          CONFIG_PVH=y

          # PCI support (required for VirtIO-PCI on ARM64)
          CONFIG_PCI=y
          CONFIG_PCI_HOST_GENERIC=y

          # Block device support (required for squashfs)
          CONFIG_BLOCK=y

          # VirtIO drivers (minimal set for cloud-hypervisor)
          CONFIG_VIRTIO=y
          CONFIG_VIRTIO_PCI=y
          CONFIG_VIRTIO_BLK=y
          CONFIG_VIRTIO_NET=y
          CONFIG_VIRTIO_CONSOLE=y
          CONFIG_VIRTIO_MMIO=y

          # Serial console
          CONFIG_SERIAL_8250=y
          CONFIG_SERIAL_8250_CONSOLE=y

          # SquashFS (required for OCI image rootfs) - only zstd compression
          CONFIG_SQUASHFS=y
          CONFIG_SQUASHFS_ZSTD=y

          # Overlay filesystem (for layered container images)
          CONFIG_OVERLAY_FS=y

          # FUSE and virtio-fs (for host-guest file sharing)
          CONFIG_FUSE_FS=y
          CONFIG_VIRTIO_FS=y

          # Minimal cgroups
          CONFIG_CGROUPS=y
          CONFIG_CGROUP_PIDS=y
          CONFIG_MEMCG=y

          # Minimal namespaces
          CONFIG_NAMESPACES=y
          CONFIG_PID_NS=y
          CONFIG_NET_NS=y

          # Minimal networking (just for VM connectivity)
          CONFIG_NET=y
          CONFIG_INET=y
          CONFIG_PACKET=y

          # Filesystem support
          CONFIG_TMPFS=y
          CONFIG_PROC_FS=y
          CONFIG_SYSFS=y
          CONFIG_DEVTMPFS=y
          CONFIG_DEVTMPFS_MOUNT=y

          # Block devices
          CONFIG_BLK_DEV_LOOP=y
          CONFIG_BLK_DEV_LOOP_MIN_COUNT=8

          # Binary format support (required for Rosetta x86_64 emulation on ARM64)
          CONFIG_BINFMT_MISC=y

          # Compression support (required by squashfs)
          CONFIG_ZLIB_INFLATE=y
          CONFIG_ZLIB_DEFLATE=y
          CONFIG_LZO_COMPRESS=y
          CONFIG_LZO_DECOMPRESS=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_LZ4_DECOMPRESS=y
          CONFIG_ZSTD_COMPRESS=y
          CONFIG_ZSTD_DECOMPRESS=y
          CONFIG_XZ_DEC=y

          # VSOCK support (required for hypr exec via vsock)
          CONFIG_VSOCKETS=y
          CONFIG_VIRTIO_VSOCKETS=y
          CONFIG_VSOCKETS_LOOPBACK=y

          # PTY support (required for interactive exec sessions)
          CONFIG_UNIX98_PTYS=y
          CONFIG_LEGACY_PTYS=n
          HYPR_CONFIG

          # Resolve any conflicts and set defaults for new options
          make olddefconfig

          # Verify critical options are enabled
          echo ""
          echo "=== Final config verification ==="
          echo ""
          echo "PVH boot (cloud-hypervisor):"
          grep CONFIG_PVH .config || echo "WARNING: PVH not found!"
          echo ""
          echo "squashfs:"
          grep CONFIG_SQUASHFS .config || echo "WARNING: SQUASHFS not found!"
          echo ""
          echo "overlay:"
          grep CONFIG_OVERLAY_FS .config || echo "WARNING: OVERLAY_FS not found!"
          echo ""
          echo "virtio-fs:"
          grep CONFIG_VIRTIO_FS .config || echo "WARNING: VIRTIO_FS not found!"
          echo ""
          echo "fuse:"
          grep CONFIG_FUSE_FS .config || echo "WARNING: FUSE_FS not found!"
          echo ""
          echo "namespaces:"
          grep -E "CONFIG_(UTS|IPC|USER|PID|NET)_NS" .config || echo "WARNING: Namespaces not found!"
          echo ""
          echo "compression libs:"
          grep -E "CONFIG_(ZLIB|LZO|LZ4|ZSTD|XZ)" .config | head -10
          echo ""
          echo "vsock (for exec):"
          grep -E "CONFIG_(VSOCKETS|VIRTIO_VSOCKETS)" .config || echo "WARNING: VSOCK not found!"

          # Final check - fail if squashfs is not enabled
          if ! grep -q "CONFIG_SQUASHFS=y" .config; then
            echo "ERROR: CONFIG_SQUASHFS=y not found in final config!"
            echo "Full .config contents related to SQUASHFS:"
            grep -i squash .config || echo "(none found)"
            exit 1
          fi

          echo ""
          echo "=== Config verification PASSED ==="

      - name: Build kernel
        working-directory: kernel
        run: |
          # Build with all available cores
          # x86_64: builds vmlinux (ELF, works with PVH boot)
          # aarch64: builds Image (direct-kernel boot, no UEFI needed!)
          make -j$(nproc) ${{ matrix.kernel_target }}

          # Show kernel info
          echo "=== Kernel built ==="
          if [ "${{ matrix.kernel_target }}" = "Image" ]; then
            ls -lh arch/arm64/boot/Image
            file arch/arm64/boot/Image
          else
            ls -lh vmlinux
            file vmlinux
          fi

      - name: Prepare kernel artifact
        run: |
          mkdir -p dist

          # Copy kernel from correct location based on target
          if [ "${{ matrix.kernel_target }}" = "Image" ]; then
            cp kernel/arch/arm64/boot/Image dist/${{ matrix.image_name }}
          else
            cp kernel/vmlinux dist/${{ matrix.image_name }}
          fi

          # Generate SHA256 checksum
          cd dist
          sha256sum ${{ matrix.image_name }} > ${{ matrix.image_name }}.sha256

          # Show artifact info
          echo "Kernel artifact:"
          ls -lh
          cat *.sha256

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}
          path: dist/*

  create-release:
    name: Create Kernel Release
    needs: build-kernel
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy all kernel binaries to release directory
          find artifacts -type f -exec cp {} release/ \;

          # List what we're releasing
          echo "Release contents:"
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ inputs.kernel_version }}-hypr
          name: Linux Kernel ${{ inputs.kernel_version }} for HYPR
          draft: false
          prerelease: false
          body: |
            ## Linux Kernel ${{ inputs.kernel_version }} for HYPR

            Custom Linux kernel built for HYPR microVMs, based on mainline Linux kernel from [kernel.org](https://kernel.org).

            ### Features Enabled

            **Filesystem Support:**
            - SquashFS (with zlib, lzo, xz, zstd, lz4 compression)
            - OverlayFS (for layered container images)
            - VirtIO-FS / FUSE (for host-guest file sharing)
            - ext4, tmpfs, procfs, sysfs, devtmpfs

            **Container Features:**
            - Namespaces (UTS, IPC, User, PID, Network)
            - Cgroups v2 (CPU, Memory, PIDs, Devices, Freezer)

            **Networking:**
            - Bridge, veth, TUN/TAP, macvlan, ipvlan
            - Netfilter / iptables / NAT

            **VirtIO Drivers:**
            - virtio_blk, virtio_net, virtio_console, virtio_fs

            ### Binaries

            | File | Architecture | Format | Description |
            |------|--------------|--------|-------------|
            | `vmlinux-x86_64` | x86_64 | ELF | Kernel for Intel/AMD (PVH boot) |
            | `Image-aarch64` | aarch64 | PE/COFF | Kernel for ARM64 (UEFI boot) |

            ### Usage

            Download the appropriate kernel for your architecture and use it with HYPR:

            ```bash
            # Linux x86_64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux

            # Linux aarch64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/Image-aarch64 -o ~/.hypr/vmlinux

            # macOS (Apple Silicon)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/Image-aarch64 -o ~/.hypr/vmlinux

            # macOS (Intel)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux
            ```

            ### Verification

            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64.sha256 -o vmlinux.sha256
            sha256sum -c vmlinux.sha256
            ```

            ### Base Kernel

            - Source: [kernel.org](https://cdn.kernel.org/pub/linux/kernel/)
            - Version: ${{ inputs.kernel_version }}
            - Base config: `x86_64_defconfig` / `defconfig` (arm64)

          files: |
            release/vmlinux-x86_64
            release/vmlinux-x86_64.sha256
            release/Image-aarch64
            release/Image-aarch64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
