name: Build Linux Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.12.8)'
        required: true
        default: '6.12.8'
        type: string
      ch_branch:
        description: 'cloud-hypervisor/linux branch (e.g., ch-6.12.8)'
        required: true
        default: 'ch-6.12.8'
        type: string

env:
  KERNEL_VERSION: ${{ inputs.kernel_version }}

jobs:
  build-kernel:
    name: Build Kernel (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            cross_compile: ""
            image_name: vmlinux-x86_64

          - arch: aarch64
            runner: ubuntu-24.04-arm
            cross_compile: ""
            image_name: vmlinux-aarch64

    steps:
      - name: Checkout hypr repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev \
            cpio \
            rsync

      - name: Clone cloud-hypervisor kernel
        run: |
          git clone --depth 1 --branch ${{ inputs.ch_branch }} \
            https://github.com/cloud-hypervisor/linux.git kernel
          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Configure kernel with cloud-hypervisor defaults
        working-directory: kernel
        run: |
          # Start with cloud-hypervisor's minimal config
          make ch_defconfig

          # Display initial config info
          echo "Initial config from ch_defconfig:"
          grep -E "CONFIG_SQUASHFS|CONFIG_OVERLAY_FS|CONFIG_FUSE_FS|CONFIG_VIRTIO_FS" .config || true

      - name: Enable additional kernel options for HYPR
        working-directory: kernel
        run: |
          # Append HYPR-specific config options to .config
          # Using cat >> ensures options are added even if not in defconfig
          cat >> .config << 'HYPR_CONFIG'

          # ============================================
          # HYPR Custom Kernel Configuration
          # ============================================

          # SquashFS (required for OCI image rootfs)
          CONFIG_SQUASHFS=y
          CONFIG_SQUASHFS_FILE_CACHE=y
          CONFIG_SQUASHFS_DECOMP_SINGLE=y
          CONFIG_SQUASHFS_ZLIB=y
          CONFIG_SQUASHFS_LZO=y
          CONFIG_SQUASHFS_XZ=y
          CONFIG_SQUASHFS_ZSTD=y
          CONFIG_SQUASHFS_LZ4=y
          CONFIG_SQUASHFS_4K_DEVBLK_SIZE=y
          CONFIG_SQUASHFS_EMBEDDED=y

          # Overlay filesystem (for layered container images)
          CONFIG_OVERLAY_FS=y

          # FUSE and virtio-fs (for host-guest file sharing)
          CONFIG_FUSE_FS=y
          CONFIG_VIRTIO_FS=y

          # Cgroups v2 (for container resource limits)
          CONFIG_CGROUPS=y
          CONFIG_CGROUP_CPUACCT=y
          CONFIG_CGROUP_DEVICE=y
          CONFIG_CGROUP_FREEZER=y
          CONFIG_CGROUP_PIDS=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_MEMCG=y
          CONFIG_CGROUP_BPF=y

          # Namespaces (for container isolation)
          CONFIG_NAMESPACES=y
          CONFIG_UTS_NS=y
          CONFIG_IPC_NS=y
          CONFIG_USER_NS=y
          CONFIG_PID_NS=y
          CONFIG_NET_NS=y

          # Networking features
          CONFIG_BRIDGE=y
          CONFIG_VETH=y
          CONFIG_TUN=y
          CONFIG_MACVLAN=y
          CONFIG_IPVLAN=y
          CONFIG_NETFILTER=y
          CONFIG_NF_CONNTRACK=y
          CONFIG_NF_NAT=y
          CONFIG_IP_NF_IPTABLES=y
          CONFIG_IP_NF_FILTER=y
          CONFIG_IP_NF_NAT=y

          # Filesystem support
          CONFIG_TMPFS=y
          CONFIG_PROC_FS=y
          CONFIG_SYSFS=y
          CONFIG_DEVTMPFS=y
          CONFIG_DEVTMPFS_MOUNT=y
          CONFIG_EXT4_FS=y

          # Block devices
          CONFIG_BLK_DEV_LOOP=y
          CONFIG_BLK_DEV_LOOP_MIN_COUNT=8

          # Compression support (required by squashfs)
          CONFIG_ZLIB_INFLATE=y
          CONFIG_ZLIB_DEFLATE=y
          CONFIG_LZO_COMPRESS=y
          CONFIG_LZO_DECOMPRESS=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_LZ4_DECOMPRESS=y
          CONFIG_ZSTD_COMPRESS=y
          CONFIG_ZSTD_DECOMPRESS=y
          CONFIG_XZ_DEC=y
          HYPR_CONFIG

          # Resolve any conflicts and set defaults for new options
          make olddefconfig

          # Verify critical options are enabled
          echo ""
          echo "=== Final config verification ==="
          echo ""
          echo "squashfs:"
          grep CONFIG_SQUASHFS .config || echo "WARNING: SQUASHFS not found!"
          echo ""
          echo "overlay:"
          grep CONFIG_OVERLAY_FS .config || echo "WARNING: OVERLAY_FS not found!"
          echo ""
          echo "virtio-fs:"
          grep CONFIG_VIRTIO_FS .config || echo "WARNING: VIRTIO_FS not found!"
          echo ""
          echo "fuse:"
          grep CONFIG_FUSE_FS .config || echo "WARNING: FUSE_FS not found!"
          echo ""
          echo "namespaces:"
          grep -E "CONFIG_(UTS|IPC|USER|PID|NET)_NS" .config || echo "WARNING: Namespaces not found!"
          echo ""
          echo "compression libs:"
          grep -E "CONFIG_(ZLIB|LZO|LZ4|ZSTD|XZ)" .config | head -10

          # Final check - fail if squashfs is not enabled
          if ! grep -q "CONFIG_SQUASHFS=y" .config; then
            echo "ERROR: CONFIG_SQUASHFS=y not found in final config!"
            echo "Full .config contents related to SQUASHFS:"
            grep -i squash .config || echo "(none found)"
            exit 1
          fi

          echo ""
          echo "=== Config verification PASSED ==="

      - name: Build kernel
        working-directory: kernel
        run: |
          # Build with all available cores
          make -j$(nproc) vmlinux

          # Show kernel info
          ls -lh vmlinux
          file vmlinux

      - name: Prepare kernel artifact
        run: |
          mkdir -p dist
          cp kernel/vmlinux dist/${{ matrix.image_name }}

          # Generate SHA256 checksum
          cd dist
          sha256sum ${{ matrix.image_name }} > ${{ matrix.image_name }}.sha256

          # Show artifact info
          echo "Kernel artifact:"
          ls -lh
          cat *.sha256

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}
          path: dist/*

  create-release:
    name: Create Kernel Release
    needs: build-kernel
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy all kernel binaries to release directory
          find artifacts -type f -exec cp {} release/ \;

          # List what we're releasing
          echo "Release contents:"
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ inputs.kernel_version }}-hypr
          name: Linux Kernel ${{ inputs.kernel_version }} for HYPR
          draft: false
          prerelease: false
          body: |
            ## Linux Kernel ${{ inputs.kernel_version }} for HYPR

            Custom Linux kernel built for HYPR microVMs, based on [cloud-hypervisor/linux](https://github.com/cloud-hypervisor/linux) branch `${{ inputs.ch_branch }}`.

            ### Features Enabled

            **Filesystem Support:**
            - SquashFS (with zlib, lzo, xz, zstd, lz4 compression)
            - OverlayFS (for layered container images)
            - VirtIO-FS / FUSE (for host-guest file sharing)
            - ext4, tmpfs, procfs, sysfs, devtmpfs

            **Container Features:**
            - Namespaces (UTS, IPC, User, PID, Network)
            - Cgroups v2 (CPU, Memory, PIDs, Devices, Freezer)

            **Networking:**
            - Bridge, veth, TUN/TAP, macvlan, ipvlan
            - Netfilter / iptables / NAT

            **VirtIO Drivers:**
            - virtio_blk, virtio_net, virtio_console, virtio_fs

            ### Binaries

            | File | Architecture | Description |
            |------|--------------|-------------|
            | `vmlinux-x86_64` | x86_64 | Uncompressed kernel for Intel/AMD |
            | `vmlinux-aarch64` | aarch64 | Uncompressed kernel for ARM64 |

            ### Usage

            Download the appropriate kernel for your architecture and use it with HYPR:

            ```bash
            # Linux x86_64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux

            # Linux aarch64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-aarch64 -o ~/.hypr/vmlinux

            # macOS (Apple Silicon)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-aarch64 -o ~/.hypr/vmlinux

            # macOS (Intel)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux
            ```

            ### Verification

            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64.sha256 -o vmlinux.sha256
            sha256sum -c vmlinux.sha256
            ```

            ### Base Kernel

            - Source: cloud-hypervisor/linux
            - Branch: ${{ inputs.ch_branch }}
            - Base config: `ch_defconfig`

          files: |
            release/vmlinux-x86_64
            release/vmlinux-x86_64.sha256
            release/vmlinux-aarch64
            release/vmlinux-aarch64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
