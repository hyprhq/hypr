name: Build Linux Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (e.g., 6.12)'
        required: true
        default: '6.12'
        type: string

env:
  KERNEL_VERSION: ${{ inputs.kernel_version }}

jobs:
  build-kernel:
    name: Build Kernel (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            cross_compile: ""
            image_name: vmlinux-x86_64
            kernel_target: vmlinux

          - arch: aarch64
            runner: ubuntu-24.04-arm
            cross_compile: ""
            image_name: Image-aarch64
            kernel_target: Image

    steps:
      - name: Checkout hypr repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev \
            cpio \
            rsync

      - name: Download mainline kernel
        run: |
          # Download mainline kernel tarball (faster than git clone)
          MAJOR_VERSION=$(echo "${{ inputs.kernel_version }}" | cut -d. -f1)
          KERNEL_URL="https://cdn.kernel.org/pub/linux/kernel/v${MAJOR_VERSION}.x/linux-${{ inputs.kernel_version }}.tar.xz"

          echo "Downloading kernel from: ${KERNEL_URL}"
          curl -fsSL "${KERNEL_URL}" -o linux.tar.xz

          echo "Extracting kernel..."
          tar -xf linux.tar.xz
          mv linux-${{ inputs.kernel_version }} kernel
          rm linux.tar.xz

          cd kernel
          echo "Kernel version: $(make kernelversion)"

      - name: Configure kernel with minimal virtio config
        working-directory: kernel
        run: |
          # Start with defconfig, then aggressively trim for size
          # ARM64 cloud-hypervisor has ~32MB kernel size limit
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            make x86_64_defconfig
          else
            make defconfig
          fi

          # Enable KVM guest support and PVH boot (required for cloud-hypervisor)
          ./scripts/config --enable CONFIG_HYPERVISOR_GUEST
          ./scripts/config --enable CONFIG_KVM_GUEST
          ./scripts/config --enable CONFIG_PARAVIRT
          ./scripts/config --enable CONFIG_PVH

          # === SIZE REDUCTION: Disable debug info (saves ~10-20MB) ===
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF4
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF5
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
          ./scripts/config --disable CONFIG_PAHOLE_HAS_SPLIT_BTF
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF_MODULES
          ./scripts/config --disable CONFIG_GDB_SCRIPTS
          ./scripts/config --enable CONFIG_DEBUG_INFO_NONE

          # === SIZE REDUCTION: Disable tracing/profiling ===
          ./scripts/config --disable CONFIG_FTRACE
          ./scripts/config --disable CONFIG_FUNCTION_TRACER
          ./scripts/config --disable CONFIG_KPROBES
          ./scripts/config --disable CONFIG_KPROBE_EVENTS
          ./scripts/config --disable CONFIG_UPROBE_EVENTS
          ./scripts/config --disable CONFIG_DYNAMIC_FTRACE
          ./scripts/config --disable CONFIG_STACK_TRACER
          ./scripts/config --disable CONFIG_SCHED_TRACER

          # === SIZE REDUCTION: Disable other debug features ===
          ./scripts/config --disable CONFIG_KALLSYMS
          ./scripts/config --disable CONFIG_KALLSYMS_ALL
          ./scripts/config --disable CONFIG_DEBUG_KERNEL
          ./scripts/config --disable CONFIG_DEBUG_MISC
          ./scripts/config --disable CONFIG_PRINTK_TIME

          # === SIZE REDUCTION: Disable unused drivers ===
          ./scripts/config --disable CONFIG_SOUND
          ./scripts/config --disable CONFIG_DRM
          ./scripts/config --disable CONFIG_USB_SUPPORT
          ./scripts/config --disable CONFIG_WIRELESS
          ./scripts/config --disable CONFIG_WLAN
          ./scripts/config --disable CONFIG_BT
          ./scripts/config --disable CONFIG_RFKILL
          ./scripts/config --disable CONFIG_INPUT_MOUSE
          ./scripts/config --disable CONFIG_INPUT_KEYBOARD

          # Display initial config info
          echo "Initial config:"
          grep -E "CONFIG_SQUASHFS|CONFIG_OVERLAY_FS|CONFIG_FUSE_FS|CONFIG_VIRTIO" .config | head -20 || true

      - name: Enable additional kernel options for HYPR
        working-directory: kernel
        run: |
          # Append HYPR-specific config options to .config
          # Using cat >> ensures options are added even if not in defconfig
          cat >> .config << 'HYPR_CONFIG'

          # ============================================
          # HYPR Custom Kernel Configuration
          # ============================================

          # PVH boot support (required for cloud-hypervisor direct kernel boot)
          CONFIG_PVH=y

          # Block device support (required for squashfs and other filesystems)
          CONFIG_BLOCK=y
          CONFIG_BLK_DEV=y

          # VirtIO drivers (required for cloud-hypervisor/vfkit)
          CONFIG_VIRTIO=y
          CONFIG_VIRTIO_PCI=y
          CONFIG_VIRTIO_PCI_LEGACY=y
          CONFIG_VIRTIO_BALLOON=y
          CONFIG_VIRTIO_BLK=y
          CONFIG_VIRTIO_NET=y
          CONFIG_VIRTIO_CONSOLE=y
          CONFIG_VIRTIO_INPUT=y
          CONFIG_HW_RANDOM_VIRTIO=y
          CONFIG_DRM_VIRTIO_GPU=n
          CONFIG_VIRTIO_MMIO=y

          # 9P filesystem (alternative to virtio-fs)
          CONFIG_NET_9P=y
          CONFIG_NET_9P_VIRTIO=y
          CONFIG_9P_FS=y
          CONFIG_9P_FS_POSIX_ACL=y

          # Serial console
          CONFIG_SERIAL_8250=y
          CONFIG_SERIAL_8250_CONSOLE=y

          # SquashFS (required for OCI image rootfs)
          CONFIG_SQUASHFS=y
          CONFIG_SQUASHFS_FILE_CACHE=y
          CONFIG_SQUASHFS_DECOMP_SINGLE=y
          CONFIG_SQUASHFS_ZLIB=y
          CONFIG_SQUASHFS_LZO=y
          CONFIG_SQUASHFS_XZ=y
          CONFIG_SQUASHFS_ZSTD=y
          CONFIG_SQUASHFS_LZ4=y
          CONFIG_SQUASHFS_4K_DEVBLK_SIZE=y
          CONFIG_SQUASHFS_EMBEDDED=y

          # Overlay filesystem (for layered container images)
          CONFIG_OVERLAY_FS=y

          # FUSE and virtio-fs (for host-guest file sharing)
          CONFIG_FUSE_FS=y
          CONFIG_VIRTIO_FS=y

          # Cgroups v2 (for container resource limits)
          CONFIG_CGROUPS=y
          CONFIG_CGROUP_CPUACCT=y
          CONFIG_CGROUP_DEVICE=y
          CONFIG_CGROUP_FREEZER=y
          CONFIG_CGROUP_PIDS=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_MEMCG=y
          CONFIG_CGROUP_BPF=y

          # Namespaces (for container isolation)
          CONFIG_NAMESPACES=y
          CONFIG_UTS_NS=y
          CONFIG_IPC_NS=y
          CONFIG_USER_NS=y
          CONFIG_PID_NS=y
          CONFIG_NET_NS=y

          # Networking features
          CONFIG_BRIDGE=y
          CONFIG_VETH=y
          CONFIG_TUN=y
          CONFIG_MACVLAN=y
          CONFIG_IPVLAN=y
          CONFIG_NETFILTER=y
          CONFIG_NF_CONNTRACK=y
          CONFIG_NF_NAT=y
          CONFIG_IP_NF_IPTABLES=y
          CONFIG_IP_NF_FILTER=y
          CONFIG_IP_NF_NAT=y

          # Filesystem support
          CONFIG_TMPFS=y
          CONFIG_PROC_FS=y
          CONFIG_SYSFS=y
          CONFIG_DEVTMPFS=y
          CONFIG_DEVTMPFS_MOUNT=y
          CONFIG_EXT4_FS=y

          # Block devices
          CONFIG_BLK_DEV_LOOP=y
          CONFIG_BLK_DEV_LOOP_MIN_COUNT=8

          # Compression support (required by squashfs)
          CONFIG_ZLIB_INFLATE=y
          CONFIG_ZLIB_DEFLATE=y
          CONFIG_LZO_COMPRESS=y
          CONFIG_LZO_DECOMPRESS=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_LZ4_DECOMPRESS=y
          CONFIG_ZSTD_COMPRESS=y
          CONFIG_ZSTD_DECOMPRESS=y
          CONFIG_XZ_DEC=y
          HYPR_CONFIG

          # Resolve any conflicts and set defaults for new options
          make olddefconfig

          # Verify critical options are enabled
          echo ""
          echo "=== Final config verification ==="
          echo ""
          echo "PVH boot (cloud-hypervisor):"
          grep CONFIG_PVH .config || echo "WARNING: PVH not found!"
          echo ""
          echo "squashfs:"
          grep CONFIG_SQUASHFS .config || echo "WARNING: SQUASHFS not found!"
          echo ""
          echo "overlay:"
          grep CONFIG_OVERLAY_FS .config || echo "WARNING: OVERLAY_FS not found!"
          echo ""
          echo "virtio-fs:"
          grep CONFIG_VIRTIO_FS .config || echo "WARNING: VIRTIO_FS not found!"
          echo ""
          echo "fuse:"
          grep CONFIG_FUSE_FS .config || echo "WARNING: FUSE_FS not found!"
          echo ""
          echo "namespaces:"
          grep -E "CONFIG_(UTS|IPC|USER|PID|NET)_NS" .config || echo "WARNING: Namespaces not found!"
          echo ""
          echo "compression libs:"
          grep -E "CONFIG_(ZLIB|LZO|LZ4|ZSTD|XZ)" .config | head -10

          # Final check - fail if squashfs is not enabled
          if ! grep -q "CONFIG_SQUASHFS=y" .config; then
            echo "ERROR: CONFIG_SQUASHFS=y not found in final config!"
            echo "Full .config contents related to SQUASHFS:"
            grep -i squash .config || echo "(none found)"
            exit 1
          fi

          echo ""
          echo "=== Config verification PASSED ==="

      - name: Build kernel
        working-directory: kernel
        run: |
          # Build with all available cores
          # x86_64: builds vmlinux (ELF, works with PVH boot)
          # aarch64: builds Image (PE/COFF, works with UEFI boot)
          make -j$(nproc) ${{ matrix.kernel_target }}

          # Show kernel info before stripping
          echo "=== Before stripping ==="
          if [ "${{ matrix.kernel_target }}" = "Image" ]; then
            ls -lh arch/arm64/boot/Image
            file arch/arm64/boot/Image
          else
            ls -lh vmlinux
            file vmlinux
          fi

      - name: Strip kernel
        working-directory: kernel
        run: |
          # Strip debug symbols to reduce kernel size
          # This can reduce size by 50-70%
          if [ "${{ matrix.kernel_target }}" = "Image" ]; then
            # ARM64 Image is already optimized, but we can strip it further
            # Use objcopy to strip debug sections
            aarch64-linux-gnu-objcopy --strip-debug arch/arm64/boot/Image arch/arm64/boot/Image.stripped 2>/dev/null || \
              objcopy --strip-debug arch/arm64/boot/Image arch/arm64/boot/Image.stripped 2>/dev/null || \
              cp arch/arm64/boot/Image arch/arm64/boot/Image.stripped
            mv arch/arm64/boot/Image.stripped arch/arm64/boot/Image

            echo "=== After stripping ==="
            ls -lh arch/arm64/boot/Image
          else
            # x86_64 vmlinux - strip debug symbols
            strip --strip-debug vmlinux -o vmlinux.stripped
            mv vmlinux.stripped vmlinux

            echo "=== After stripping ==="
            ls -lh vmlinux
            file vmlinux
          fi

      - name: Prepare kernel artifact
        run: |
          mkdir -p dist

          # Copy kernel from correct location based on target
          if [ "${{ matrix.kernel_target }}" = "Image" ]; then
            cp kernel/arch/arm64/boot/Image dist/${{ matrix.image_name }}
          else
            cp kernel/vmlinux dist/${{ matrix.image_name }}
          fi

          # Generate SHA256 checksum
          cd dist
          sha256sum ${{ matrix.image_name }} > ${{ matrix.image_name }}.sha256

          # Show artifact info
          echo "Kernel artifact:"
          ls -lh
          cat *.sha256

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ matrix.arch }}
          path: dist/*

  create-release:
    name: Create Kernel Release
    needs: build-kernel
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy all kernel binaries to release directory
          find artifacts -type f -exec cp {} release/ \;

          # List what we're releasing
          echo "Release contents:"
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ inputs.kernel_version }}-hypr
          name: Linux Kernel ${{ inputs.kernel_version }} for HYPR
          draft: false
          prerelease: false
          body: |
            ## Linux Kernel ${{ inputs.kernel_version }} for HYPR

            Custom Linux kernel built for HYPR microVMs, based on mainline Linux kernel from [kernel.org](https://kernel.org).

            ### Features Enabled

            **Filesystem Support:**
            - SquashFS (with zlib, lzo, xz, zstd, lz4 compression)
            - OverlayFS (for layered container images)
            - VirtIO-FS / FUSE (for host-guest file sharing)
            - ext4, tmpfs, procfs, sysfs, devtmpfs

            **Container Features:**
            - Namespaces (UTS, IPC, User, PID, Network)
            - Cgroups v2 (CPU, Memory, PIDs, Devices, Freezer)

            **Networking:**
            - Bridge, veth, TUN/TAP, macvlan, ipvlan
            - Netfilter / iptables / NAT

            **VirtIO Drivers:**
            - virtio_blk, virtio_net, virtio_console, virtio_fs

            ### Binaries

            | File | Architecture | Format | Description |
            |------|--------------|--------|-------------|
            | `vmlinux-x86_64` | x86_64 | ELF | Kernel for Intel/AMD (PVH boot) |
            | `Image-aarch64` | aarch64 | PE/COFF | Kernel for ARM64 (UEFI boot) |

            ### Usage

            Download the appropriate kernel for your architecture and use it with HYPR:

            ```bash
            # Linux x86_64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux

            # Linux aarch64
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/Image-aarch64 -o ~/.hypr/vmlinux

            # macOS (Apple Silicon)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/Image-aarch64 -o ~/.hypr/vmlinux

            # macOS (Intel)
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64 -o ~/.hypr/vmlinux
            ```

            ### Verification

            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/kernel-${{ inputs.kernel_version }}-hypr/vmlinux-x86_64.sha256 -o vmlinux.sha256
            sha256sum -c vmlinux.sha256
            ```

            ### Base Kernel

            - Source: [kernel.org](https://cdn.kernel.org/pub/linux/kernel/)
            - Version: ${{ inputs.kernel_version }}
            - Base config: `x86_64_defconfig` / `defconfig` (arm64)

          files: |
            release/vmlinux-x86_64
            release/vmlinux-x86_64.sha256
            release/Image-aarch64
            release/Image-aarch64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
