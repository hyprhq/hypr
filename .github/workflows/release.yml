name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build Rust binaries for all platforms
  # NOTE: Kestrel is now embedded at compile-time via build.rs
  build-rust:
    name: Build Rust (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch: amd64
            platform: linux

          # Linux aarch64 (native arm64 runner!)
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            arch: arm64
            platform: linux

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            arch: amd64
            platform: darwin

          # macOS aarch64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
            platform: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config protobuf-compiler libelf-dev zlib1g-dev clang libbpf-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install protobuf zig

      - name: Install Zig (Linux - for cross-compiling kestrel)
        if: runner.os == 'Linux'
        run: |
          # Detect host architecture and download appropriate Zig
          if [ "$(uname -m)" == "aarch64" ]; then
            ZIG_ARCH="aarch64"
          else
            ZIG_ARCH="x86_64"
          fi

          wget https://ziglang.org/download/0.11.0/zig-linux-${ZIG_ARCH}-0.11.0.tar.xz
          tar -xf zig-linux-${ZIG_ARCH}-0.11.0.tar.xz
          sudo mv zig-linux-${ZIG_ARCH}-0.11.0 /usr/local/zig
          # Verify zig is accessible
          /usr/local/zig/zig version

      - name: Pre-build initramfs archives (before cargo build)
        run: |
          # Ensure embedded directory exists
          mkdir -p hypr-core/embedded

          # Select zig binary based on platform
          if [ "$RUNNER_OS" == "macOS" ]; then
            ZIG_BIN="zig"
          else
            ZIG_BIN="/usr/local/zig/zig"
          fi

          # Function to build complete initramfs for an architecture
          build_initramfs() {
            ARCH=$1
            ZIG_TARGET=$2

            echo "Building initramfs for linux-${ARCH}..."

            # Create temp directory
            TEMP_DIR=$(mktemp -d)

            # Step 1: Compile kestrel
            echo "  Compiling kestrel..."
            $ZIG_BIN cc -target $ZIG_TARGET -static -Os -s \
              -o $TEMP_DIR/init \
              guest/kestrel.c
            chmod +x $TEMP_DIR/init

            # Step 2: Download busybox
            echo "  Downloading busybox..."
            mkdir -p $TEMP_DIR/bin
            if [ "$ARCH" == "amd64" ]; then
              DEB_URL="https://ftp.debian.org/debian/pool/main/b/busybox/busybox-static_1.37.0-7_amd64.deb"
            else
              DEB_URL="https://ftp.debian.org/debian/pool/main/b/busybox/busybox-static_1.37.0-7_arm64.deb"
            fi

            curl -fsSL $DEB_URL -o $TEMP_DIR/busybox.deb
            cd $TEMP_DIR && ar x busybox.deb data.tar.xz
            tar -xf data.tar.xz ./usr/bin/busybox
            mv usr/bin/busybox bin/busybox
            chmod +x bin/busybox
            rm -rf busybox.deb data.tar.xz usr

            # Step 3: Move busybox to root (ultra-minimal structure)
            # No directories needed - kestrel creates them at boot!
            mv bin/busybox busybox
            rmdir bin

            # Step 4: Create cpio archive
            echo "  Creating cpio archive..."
            find . -print0 | cpio -0 -o -H newc > ${GITHUB_WORKSPACE}/hypr-core/embedded/initramfs-linux-${ARCH}.cpio

            # Cleanup
            cd $GITHUB_WORKSPACE
            rm -rf $TEMP_DIR

            echo "  ✓ initramfs-linux-${ARCH}.cpio created ($(stat -f%z hypr-core/embedded/initramfs-linux-${ARCH}.cpio 2>/dev/null || stat -c%s hypr-core/embedded/initramfs-linux-${ARCH}.cpio) bytes)"
          }

          # Build for both architectures
          build_initramfs "amd64" "x86_64-linux-musl"
          build_initramfs "arm64" "aarch64-linux-musl"

          # Verify archives exist and are valid cpio
          echo ""
          echo "Verifying initramfs archives:"
          ls -lh hypr-core/embedded/
          head -c 6 hypr-core/embedded/initramfs-linux-amd64.cpio | od -c
          head -c 6 hypr-core/embedded/initramfs-linux-arm64.cpio | od -c

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Rust workspace (kestrel embedded automatically via build.rs)
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Prepare binaries
        run: |
          mkdir -p dist

          # hypr-cli binary (cargo builds as 'hypr-cli') → rename to hypr-{platform}-{arch}
          cp target/${{ matrix.target }}/release/hypr-cli dist/hypr-${{ matrix.platform }}-${{ matrix.arch }}

          # hypr-daemon binary (cargo builds as 'hypr-daemon') → rename to hyprd-{platform}-{arch}
          cp target/${{ matrix.target }}/release/hypr-daemon dist/hyprd-${{ matrix.platform }}-${{ matrix.arch }}

          # Make executable
          chmod +x dist/hypr-${{ matrix.platform }}-${{ matrix.arch }}
          chmod +x dist/hyprd-${{ matrix.platform }}-${{ matrix.arch }}

          # Generate checksums
          cd dist
          shasum -a 256 hypr-${{ matrix.platform }}-${{ matrix.arch }} > hypr-${{ matrix.platform }}-${{ matrix.arch }}.sha256
          shasum -a 256 hyprd-${{ matrix.platform }}-${{ matrix.arch }} > hyprd-${{ matrix.platform }}-${{ matrix.arch }}.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-rust]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy all binaries to release directory
          find artifacts -type f -exec cp {} release/ \;

          # List what we're releasing
          echo "Release contents:"
          ls -lh release/

          # Verify we have 8 binaries + checksums
          echo ""
          echo "Binary count:"
          ls -1 release/ | grep -v ".sha256" | wc -l
          echo "Expected: 8 binaries (hypr + hyprd × 4 platforms)"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## HYPR Release ${{ inputs.version }}

            ### Binaries Included

            **HYPR CLI + Daemon (with embedded initramfs):**
            - Linux: `hypr-linux-amd64`, `hypr-linux-arm64`, `hyprd-linux-amd64`, `hyprd-linux-arm64`
            - macOS: `hypr-darwin-amd64`, `hypr-darwin-arm64`, `hyprd-darwin-amd64`, `hyprd-darwin-arm64`

            **Note:** Complete initramfs (kestrel + busybox) is now embedded in the binaries at compile-time.
            Zero network dependencies at runtime!

            ### Installation

            **Linux (x86_64):**
            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/${{ inputs.version }}/hypr-linux-amd64 -o hypr
            chmod +x hypr
            sudo mv hypr /usr/local/bin/
            ```

            **macOS (Apple Silicon):**
            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/${{ inputs.version }}/hypr-darwin-arm64 -o hypr
            chmod +x hypr
            sudo mv hypr /usr/local/bin/
            ```

            ### Custom Initramfs (Advanced)

            If you need a custom initramfs for development or testing:
            ```bash
            export INITRAMFS_PATH=/path/to/custom/initramfs.cpio
            hypr build -t myapp .
            ```

            ### Verification

            All binaries include SHA256 checksums for verification:
            ```bash
            curl -fsSL https://github.com/hyprhq/hypr/releases/download/${{ inputs.version }}/hypr-linux-amd64.sha256 -o hypr.sha256
            shasum -a 256 -c hypr.sha256
            ```

            ### What's Changed

            See commit history for detailed changes.
          files: |
            release/hypr-linux-amd64
            release/hypr-linux-amd64.sha256
            release/hypr-linux-arm64
            release/hypr-linux-arm64.sha256
            release/hypr-darwin-amd64
            release/hypr-darwin-amd64.sha256
            release/hypr-darwin-arm64
            release/hypr-darwin-arm64.sha256
            release/hyprd-linux-amd64
            release/hyprd-linux-amd64.sha256
            release/hyprd-linux-arm64
            release/hyprd-linux-arm64.sha256
            release/hyprd-darwin-amd64
            release/hyprd-darwin-amd64.sha256
            release/hyprd-darwin-arm64
            release/hyprd-darwin-arm64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Verify release integrity
  verify-release:
    name: Verify Release
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Download release assets
        run: |
          VERSION="${{ inputs.version }}"

          # Download and verify a few key binaries
          curl -fsSL "https://github.com/hyprhq/hypr/releases/download/${VERSION}/hypr-linux-amd64" -o hypr-linux-amd64
          curl -fsSL "https://github.com/hyprhq/hypr/releases/download/${VERSION}/hypr-linux-amd64.sha256" -o hypr-linux-amd64.sha256

          # Verify checksum
          shasum -a 256 -c hypr-linux-amd64.sha256

          # Verify it's executable
          chmod +x hypr-linux-amd64
          file hypr-linux-amd64

          echo "✅ Release verification passed"
